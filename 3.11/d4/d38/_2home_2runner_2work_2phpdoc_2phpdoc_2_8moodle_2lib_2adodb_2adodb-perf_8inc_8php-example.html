<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Moodle PHP Documentation: /home/runner/work/phpdoc/phpdoc/.moodle/lib/adodb/adodb-perf.inc.php</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<link rel="search" href="../../search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Moodle PHP Documentation"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-styles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Moodle-Logo-ReversedWhite_RGB.svg"/></td>
  <td id="projectalign">
   <div id="projectname">Moodle PHP Documentation<span id="projectnumber">&#160;3.11</span>
   </div>
   <div id="projectbrief">Moodle 3.11.14+ (Build: 20230602) (5291b32c63)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,true,'search.php','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">/home/runner/work/phpdoc/phpdoc/.moodle/lib/adodb/adodb-perf.inc.php</div></div>
</div><!--header-->
<div class="contents">
<p>Reorganise multiple table-indices/statistics/.</p>
<p>Reorganise multiple table-indices/statistics/.. OptimizeMode could be given by last Parameter</p>
<pre>
         optimizeTables( 'tableA');
     </pre> <pre>
         optimizeTables( 'tableA', 'tableB', 'tableC');
     </pre> <pre>
         optimizeTables( 'tableA', 'tableB', ADODB_OPT_LOW);
     </pre><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">string</td><td>table name of the table to optimize </td></tr>
    <tr><td class="paramname">int</td><td>mode optimization-mode <code>ADODB_OPT_HIGH</code> for full optimization <code>ADODB_OPT_LOW</code> for CPU-less optimization Default is LOW <code>ADODB_OPT_LOW</code> </td></tr>
  </table>
  </dd>
</dl>
<dl class="section author"><dt>Author</dt><dd>Markus Staab </dd></dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">Returns</td><td><code>true</code> on success and <code>false</code> on error</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line">&lt;?php</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">@version   v5.21.0  2021-02-27</span></div>
<div class="line"><span class="comment">@copyright (c) 2000-2013 John Lim (jlim#natsoft.com). All rights reserved.</span></div>
<div class="line"><span class="comment">@copyright (c) 2014      Damien Regad, Mark Newnham and the ADOdb community</span></div>
<div class="line"><span class="comment">  Released under both BSD license and Lesser GPL library license.</span></div>
<div class="line"><span class="comment">  Whenever there is any discrepancy between the two licenses,</span></div>
<div class="line"><span class="comment">  the BSD license will take precedence. See License.txt.</span></div>
<div class="line"><span class="comment">  Set tabs to 4 for best viewing.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  Latest version is available at https://adodb.org/</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  Library for basic performance monitoring and tuning.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  My apologies if you see code mixed with presentation. The presentation suits</span></div>
<div class="line"><span class="comment">  my needs. If you want to separate code from presentation, be my guest. Patches</span></div>
<div class="line"><span class="comment">  are welcome.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (!<a id="a0" name="a0"></a><a class="code hl_variable" href="../../d0/de1/group__core.html#ga4806e88f79ea3f4220bb2e1bc67ed1a2">defined</a>(<span class="stringliteral">&#39;ADODB_DIR&#39;</span>)) include_once(dirname(__FILE__).<span class="stringliteral">&#39;/adodb.inc.php&#39;</span>);</div>
<div class="line">include_once(ADODB_DIR.<span class="stringliteral">&#39;/tohtml.inc.php&#39;</span>);</div>
<div class="line"> </div>
<div class="line">define( <span class="stringliteral">&#39;ADODB_OPT_HIGH&#39;</span>, 2);</div>
<div class="line">define( <span class="stringliteral">&#39;ADODB_OPT_LOW&#39;</span>, 1);</div>
<div class="line"> </div>
<div class="line">global $ADODB_PERF_MIN;</div>
<div class="line">$ADODB_PERF_MIN = 0.05; <span class="comment">// log only if &gt;= minimum number of secs to run</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// returns in K the memory of current process, or 0 if not known</span></div>
<div class="line"><span class="keyword">function</span> adodb_getmem()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;memory_get_usage&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> (integer) ((memory_get_usage()+512)/1024);</div>
<div class="line"> </div>
<div class="line">    $pid = getmypid();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ( strncmp(strtoupper(PHP_OS),<span class="stringliteral">&#39;WIN&#39;</span>,3)==0) {</div>
<div class="line">        $output = <a class="code hl_namespace" href="../../d7/df9/namespacearray.html">array</a>();</div>
<div class="line"> </div>
<div class="line">        exec(<span class="stringliteral">&#39;tasklist /FI &quot;PID eq &#39;</span> . $pid. <span class="stringliteral">&#39;&quot; /FO LIST&#39;</span>, $output);</div>
<div class="line">        <span class="keywordflow">return</span> substr($output[5], strpos($output[5], <span class="charliteral">&#39;:&#39;</span>) + 1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Hopefully UNIX */</span></div>
<div class="line">    exec(<span class="stringliteral">&quot;ps --pid $pid --no-headers -o%mem,size&quot;</span>, $output);</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($output) == 0) <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    $memarr = explode(<span class="charliteral">&#39; &#39;</span>,$output[0]);</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($memarr)&gt;=2) <span class="keywordflow">return</span> (integer) $memarr[1];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// avoids localization problems where , is used instead of .</span></div>
<div class="line"><span class="keyword">function</span> adodb_round($n,$prec)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> number_format($n, $prec, <span class="charliteral">&#39;.&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* obsolete: return microtime value as a float. Retained for backward compat */</span></div>
<div class="line"><span class="keyword">function</span> adodb_microtime()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> microtime(<span class="keyword">true</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* sql code timing */</span></div>
<div class="line"><span class="keyword">function</span> adodb_log_sql(&amp;$connx,$sql,$inputarr)</div>
<div class="line">{</div>
<div class="line">    $perf_table = adodb_perf::table();</div>
<div class="line">    $connx-&gt;fnExecute = <span class="keyword">false</span>;</div>
<div class="line">    $a0 = microtime(<span class="keyword">true</span>);</div>
<div class="line">    $rs = $connx-&gt;Execute($sql,$inputarr);</div>
<div class="line">    $a1 = microtime(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!empty($connx-&gt;_logsql) &amp;&amp; (empty($connx-&gt;_logsqlErrors) || !$rs)) {</div>
<div class="line">    global $ADODB_LOG_CONN;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!empty($ADODB_LOG_CONN)) {</div>
<div class="line">            $conn = $ADODB_LOG_CONN;</div>
<div class="line">            <span class="keywordflow">if</span> ($conn-&gt;databaseType != $connx-&gt;databaseType)</div>
<div class="line">                $prefix = <span class="stringliteral">&#39;/*dbx=&#39;</span>.$connx-&gt;databaseType .<span class="stringliteral">&#39;*/ &#39;</span>;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                $prefix = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $conn = $connx;</div>
<div class="line">            $prefix = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        $conn-&gt;_logsql = <span class="keyword">false</span>; <span class="comment">// disable logsql error simulation</span></div>
<div class="line">        $dbT = $conn-&gt;databaseType;</div>
<div class="line"> </div>
<div class="line">        $time = $a1 - $a0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!$rs) {</div>
<div class="line">            $errM = $connx-&gt;ErrorMsg();</div>
<div class="line">            $errN = $connx-&gt;ErrorNo();</div>
<div class="line">            $conn-&gt;lastInsID = 0;</div>
<div class="line">            $tracer = substr(<span class="stringliteral">&#39;ERROR: &#39;</span>.htmlspecialchars($errM),0,250);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $tracer = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">            $errM = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">            $errN = 0;</div>
<div class="line">            $dbg = $conn-&gt;debug;</div>
<div class="line">            $conn-&gt;debug = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (!is_object($rs) || $rs-&gt;dataProvider == <span class="stringliteral">&#39;empty&#39;</span>)</div>
<div class="line">                $conn-&gt;_affected = $conn-&gt;affected_rows(<span class="keyword">true</span>);</div>
<div class="line">            $conn-&gt;lastInsID = @$conn-&gt;Insert_ID();</div>
<div class="line">            $conn-&gt;debug = $dbg;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (isset($_SERVER[<span class="stringliteral">&#39;HTTP_HOST&#39;</span>])) {</div>
<div class="line">            $tracer .= <span class="stringliteral">&#39;&lt;br&gt;&#39;</span>.$_SERVER[<span class="stringliteral">&#39;HTTP_HOST&#39;</span>];</div>
<div class="line">            <span class="keywordflow">if</span> (isset($_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>])) $tracer .= htmlspecialchars($_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]);</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">if</span> (isset($_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>])) $tracer .= <span class="stringliteral">&#39;&lt;br&gt;&#39;</span>.htmlspecialchars($_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]);</div>
<div class="line">        <span class="comment">//$tracer .= (string) adodb_backtrace(false);</span></div>
<div class="line"> </div>
<div class="line">        $tracer = (string) substr($tracer,0,500);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (is_array($inputarr)) {</div>
<div class="line">            <span class="keywordflow">if</span> (is_array(<a class="code hl_function" href="../../dc/d71/group___imap___client.html#ga4a20559544fdf4dcb457e258dc976cf8">reset</a>($inputarr))) $params = <span class="stringliteral">&#39;Array sizeof=&#39;</span>.<span class="keyword">sizeof</span>($inputarr);</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="comment">// Quote string parameters so we can see them in the</span></div>
<div class="line">                <span class="comment">// performance stats. This helps spot disabled indexes.</span></div>
<div class="line">                $xar_params = $inputarr;</div>
<div class="line">                <span class="keywordflow">foreach</span> ($xar_params as $xar_param_key =&gt; $xar_param) {</div>
<div class="line">                    <span class="keywordflow">if</span> (gettype($xar_param) == <span class="stringliteral">&#39;string&#39;</span>)</div>
<div class="line">                    $xar_params[$xar_param_key] = <span class="charliteral">&#39;&quot;&#39;</span> . $xar_param . <span class="charliteral">&#39;&quot;&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">                $params = implode(<span class="stringliteral">&#39;, &#39;</span>, $xar_params);</div>
<div class="line">                <span class="keywordflow">if</span> (strlen($params) &gt;= 3000) $params = substr($params, 0, 3000);</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $params = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (is_array($sql)) $sql = $sql[0];</div>
<div class="line">        <span class="keywordflow">if</span> ($prefix) $sql = $prefix.$sql;</div>
<div class="line">        $arr = <a class="code hl_namespace" href="../../d7/df9/namespacearray.html">array</a>(<span class="charliteral">&#39;b&#39;</span>=&gt;strlen($sql).<span class="charliteral">&#39;.&#39;</span>.crc32($sql),</div>
<div class="line">                    <span class="charliteral">&#39;c&#39;</span>=&gt;substr($sql,0,3900), <span class="charliteral">&#39;d&#39;</span>=&gt;$params,<span class="charliteral">&#39;e&#39;</span>=&gt;$tracer,<span class="charliteral">&#39;f&#39;</span>=&gt;adodb_round($time,6));</div>
<div class="line">        <span class="comment">//var_dump($arr);</span></div>
<div class="line">        $saved = $conn-&gt;debug;</div>
<div class="line">        $conn-&gt;debug = 0;</div>
<div class="line"> </div>
<div class="line">        $d = $conn-&gt;sysTimeStamp;</div>
<div class="line">        <span class="keywordflow">if</span> (empty($d)) $d = date(<span class="stringliteral">&quot;&#39;Y-m-d H:i:s&#39;&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> ($conn-&gt;dataProvider == <span class="stringliteral">&#39;oci8&#39;</span> &amp;&amp; $dbT != <span class="stringliteral">&#39;oci8po&#39;</span>) {</div>
<div class="line">            $isql = <span class="stringliteral">&quot;insert into $perf_table values($d,:b,:c,:d,:e,:f)&quot;</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($dbT == <span class="stringliteral">&#39;mssqlnative&#39;</span> || $dbT == <span class="stringliteral">&#39;odbc_mssql&#39;</span> || $dbT == <span class="stringliteral">&#39;informix&#39;</span> || strncmp($dbT,<span class="stringliteral">&#39;odbtp&#39;</span>,4)==0) {</div>
<div class="line">            $timer = $arr[<span class="charliteral">&#39;f&#39;</span>];</div>
<div class="line">            <span class="keywordflow">if</span> ($dbT == <span class="stringliteral">&#39;informix&#39;</span>) $sql2 = substr($sql2,0,230);</div>
<div class="line"> </div>
<div class="line">            $sql1 = $conn-&gt;qstr($arr[<span class="charliteral">&#39;b&#39;</span>]);</div>
<div class="line">            $sql2 = $conn-&gt;qstr($arr[<span class="charliteral">&#39;c&#39;</span>]);</div>
<div class="line">            $params = $conn-&gt;qstr($arr[<span class="charliteral">&#39;d&#39;</span>]);</div>
<div class="line">            $tracer = $conn-&gt;qstr($arr[<span class="charliteral">&#39;e&#39;</span>]);</div>
<div class="line"> </div>
<div class="line">            $isql = <span class="stringliteral">&quot;insert into $perf_table (created,sql0,sql1,params,tracer,timer) values($d,$sql1,$sql2,$params,$tracer,$timer)&quot;</span>;</div>
<div class="line">            <span class="keywordflow">if</span> ($dbT == <span class="stringliteral">&#39;informix&#39;</span>) $isql = str_replace(chr(10),<span class="charliteral">&#39; &#39;</span>,$isql);</div>
<div class="line">            $arr = <span class="keyword">false</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> ($dbT == <span class="stringliteral">&#39;db2&#39;</span>) $arr[<span class="charliteral">&#39;f&#39;</span>] = (float) $arr[<span class="charliteral">&#39;f&#39;</span>];</div>
<div class="line">            $isql = <span class="stringliteral">&quot;insert into $perf_table (created,sql0,sql1,params,tracer,timer) values( $d,?,?,?,?,?)&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        global $ADODB_PERF_MIN;</div>
<div class="line">        <span class="keywordflow">if</span> ($errN != 0 || $time &gt;= $ADODB_PERF_MIN) {</div>
<div class="line">            <span class="keywordflow">if</span>($conn instanceof ADODB_mysqli &amp;&amp; $conn-&gt;_queryID) {</div>
<div class="line">                mysqli_free_result($conn-&gt;_queryID);</div>
<div class="line">            }</div>
<div class="line">            $ok = $conn-&gt;Execute($isql,$arr);</div>
<div class="line">            <span class="keywordflow">if</span>($conn instanceof ADODB_mysqli &amp;&amp; $conn-&gt;_queryID){</div>
<div class="line">                mysqli_free_result($conn-&gt;_queryID);</div>
<div class="line">                    }</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            $ok = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">        $conn-&gt;debug = $saved;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ($ok) {</div>
<div class="line">            $conn-&gt;_logsql = <span class="keyword">true</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $err2 = $conn-&gt;ErrorMsg();</div>
<div class="line">            $conn-&gt;_logsql = <span class="keyword">true</span>; <span class="comment">// enable logsql error simulation</span></div>
<div class="line">            $perf = NewPerfMonitor($conn);</div>
<div class="line">            <span class="keywordflow">if</span> ($perf) {</div>
<div class="line">                <span class="keywordflow">if</span> ($perf-&gt;CreateLogTable()) $ok = $conn-&gt;Execute($isql,$arr);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                $ok = $conn-&gt;Execute(<span class="stringliteral">&quot;create table $perf_table (</span></div>
<div class="line"><span class="stringliteral">                created varchar(50),</span></div>
<div class="line"><span class="stringliteral">                sql0 varchar(250),</span></div>
<div class="line"><span class="stringliteral">                sql1 varchar(4000),</span></div>
<div class="line"><span class="stringliteral">                params varchar(3000),</span></div>
<div class="line"><span class="stringliteral">                tracer varchar(500),</span></div>
<div class="line"><span class="stringliteral">                timer decimal(16,6))&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (!$ok) {</div>
<div class="line">                ADOConnection::outp( <span class="stringliteral">&quot;&lt;p&gt;&lt;b&gt;LOGSQL Insert Failed&lt;/b&gt;: $isql&lt;br&gt;$err2&lt;/p&gt;&quot;</span>);</div>
<div class="line">                $conn-&gt;_logsql = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        $connx-&gt;_errorMsg = $errM;</div>
<div class="line">        $connx-&gt;_errorCode = $errN;</div>
<div class="line">    }</div>
<div class="line">    $connx-&gt;fnExecute = <span class="stringliteral">&#39;adodb_log_sql&#39;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> $rs;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">The settings data structure is an associative array that database parameter per element.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">Each database parameter element in the array is itself an array consisting of:</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">0: category code, used to group related db parameters</span></div>
<div class="line"><span class="comment">1: either</span></div>
<div class="line"><span class="comment">    a. sql string to retrieve value, eg. &quot;select value from v\$parameter where name=&#39;db_block_size&#39;&quot;,</span></div>
<div class="line"><span class="comment">    b. array holding sql string and field to look for, e.g. array(&#39;show variables&#39;,&#39;table_cache&#39;),</span></div>
<div class="line"><span class="comment">    c. a string prefixed by =, then a PHP method of the class is invoked,</span></div>
<div class="line"><span class="comment">        e.g. to invoke $this-&gt;GetIndexValue(), set this array element to &#39;=GetIndexValue&#39;,</span></div>
<div class="line"><span class="comment">2: description of the database parameter</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span><a id="_a1" name="_a1"></a><a class="code hl_class" href="../../de/d06/classadodb__perf.html">adodb_perf</a> {</div>
<div class="line">    var $conn;</div>
<div class="line">    var $color = <span class="stringliteral">&#39;#F0F0F0&#39;</span>;</div>
<div class="line">    var $table = <span class="stringliteral">&#39;&lt;table border=1 bgcolor=white&gt;&#39;</span>;</div>
<div class="line">    var $titles = <span class="stringliteral">&#39;&lt;tr&gt;&lt;td&gt;&lt;b&gt;Parameter&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;Value&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;Description&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>;</div>
<div class="line">    var $warnRatio = 90;</div>
<div class="line">    var $tablesSQL = <span class="keyword">false</span>;</div>
<div class="line">    var $cliFormat = <span class="stringliteral">&quot;%32s =&gt; %s \r\n&quot;</span>;</div>
<div class="line">    var $sql1 = <span class="stringliteral">&#39;sql1&#39;</span>;  <span class="comment">// used for casting sql1 to text for mssql</span></div>
<div class="line">    var $explain = <span class="keyword">true</span>;</div>
<div class="line">    var $helpurl = <span class="stringliteral">&#39;&lt;a href=&quot;https://adodb.org/dokuwiki/doku.php?id=v5:performance:logsql&quot;&gt;LogSQL help&lt;/a&gt;&#39;</span>;</div>
<div class="line">    var $createTableSQL = <span class="keyword">false</span>;</div>
<div class="line">    var $maxLength = 2000;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Sets the tablename to be used</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">function</span> table($newtable = <span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">static</span> $_table;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!empty($newtable))  $_table = $newtable;</div>
<div class="line">        <span class="keywordflow">if</span> (empty($_table)) $_table = <span class="stringliteral">&#39;adodb_logsql&#39;</span>;</div>
<div class="line">        <span class="keywordflow">return</span> $_table;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// returns array with info to calculate CPU Load</span></div>
<div class="line">    <span class="keyword">function</span> _CPULoad()</div>
<div class="line">    {</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">cpu  524152 2662 2515228 336057010</span></div>
<div class="line"><span class="comment">cpu0 264339 1408 1257951 168025827</span></div>
<div class="line"><span class="comment">cpu1 259813 1254 1257277 168031181</span></div>
<div class="line"><span class="comment">page 622307 25475680</span></div>
<div class="line"><span class="comment">swap 24 1891</span></div>
<div class="line"><span class="comment">intr 890153570 868093576 6 0 4 4 0 6 1 2 0 0 0 124 0 8098760 2 13961053 0 0 0 0 0 0 0 0 0 0 0 0 0 16 16 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span></div>
<div class="line"><span class="comment">disk_io: (3,0):(3144904,54369,610378,3090535,50936192) (3,1):(3630212,54097,633016,3576115,50951320)</span></div>
<div class="line"><span class="comment">ctxt 66155838</span></div>
<div class="line"><span class="comment">btime 1062315585</span></div>
<div class="line"><span class="comment">processes 69293</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">*/</span></div>
<div class="line">        <span class="comment">// Algorithm is taken from</span></div>
<div class="line">        <span class="comment">// http://social.technet.microsoft.com/Forums/en-US/winservergen/thread/414b0e1b-499c-411e-8a02-6a12e339c0f1/</span></div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(PHP_OS,<span class="stringliteral">&#39;WIN&#39;</span>,3)==0) {</div>
<div class="line">            <span class="keyword">static</span> $FAIL = <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">if</span> ($FAIL) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">            $objName = <span class="stringliteral">&quot;winmgmts:{impersonationLevel=impersonate}!\\\\.\\root\\CIMV2&quot;</span>;</div>
<div class="line">            $myQuery = <span class="stringliteral">&quot;SELECT * FROM Win32_PerfFormattedData_PerfOS_Processor WHERE Name = &#39;_Total&#39;&quot;</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">try</span> {</div>
<div class="line">                @$objWMIService = <span class="keyword">new</span> COM($objName);</div>
<div class="line">                <span class="keywordflow">if</span> (!$objWMIService) {</div>
<div class="line">                    $FAIL = <span class="keyword">true</span>;</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                $info[0] = -1;</div>
<div class="line">                $info[1] = 0;</div>
<div class="line">                $info[2] = 0;</div>
<div class="line">                $info[3] = 0;</div>
<div class="line">                <span class="keywordflow">foreach</span>($objWMIService-&gt;ExecQuery($myQuery) as $objItem)  {</div>
<div class="line">                        $info[0] = $objItem-&gt;PercentProcessorTime();</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">            } <span class="keywordflow">catch</span>(<a id="_a2" name="_a2"></a><a class="code hl_class" href="../../df/d70/class_exception.html">Exception</a> $e) {</div>
<div class="line">                $FAIL = <span class="keyword">true</span>;</div>
<div class="line">                echo $e-&gt;getMessage();</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">return</span> $info;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Algorithm - Steve Blinch (BlitzAffe Online, http://www.blitzaffe.com)</span></div>
<div class="line">        $statfile = <span class="stringliteral">&#39;/proc/stat&#39;</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (!file_exists($statfile)) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        $fd = <a class="code hl_function" href="../../d5/d41/group___support.html#ga4f0f28af205235b0726da91caf226b9f">fopen</a>($statfile,<span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (!$fd) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        $statinfo = explode(<span class="stringliteral">&quot;\n&quot;</span>,fgets($fd, 1024));</div>
<div class="line">        fclose($fd);</div>
<div class="line">        <span class="keywordflow">foreach</span>($statinfo as $line) {</div>
<div class="line">            $info = explode(<span class="stringliteral">&quot; &quot;</span>,$line);</div>
<div class="line">            <span class="keywordflow">if</span>($info[0]==<span class="stringliteral">&quot;cpu&quot;</span>) {</div>
<div class="line">                array_shift($info);  <span class="comment">// pop off &quot;cpu&quot;</span></div>
<div class="line">                <span class="keywordflow">if</span>(!$info[0]) array_shift($info); <span class="comment">// pop off blank space (if any)</span></div>
<div class="line">                <span class="keywordflow">return</span> $info;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* NOT IMPLEMENTED */</span></div>
<div class="line">    <span class="keyword">function</span> MemInfo()</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">        total:    used:    free:  shared: buffers:  cached:</span></div>
<div class="line"><span class="comment">Mem:  1055289344 917299200 137990144        0 165437440 599773184</span></div>
<div class="line"><span class="comment">Swap: 2146775040 11055104 2135719936</span></div>
<div class="line"><span class="comment">MemTotal:      1030556 kB</span></div>
<div class="line"><span class="comment">MemFree:        134756 kB</span></div>
<div class="line"><span class="comment">MemShared:           0 kB</span></div>
<div class="line"><span class="comment">Buffers:        161560 kB</span></div>
<div class="line"><span class="comment">Cached:         581384 kB</span></div>
<div class="line"><span class="comment">SwapCached:       4332 kB</span></div>
<div class="line"><span class="comment">Active:         494468 kB</span></div>
<div class="line"><span class="comment">Inact_dirty:    322856 kB</span></div>
<div class="line"><span class="comment">Inact_clean:     24256 kB</span></div>
<div class="line"><span class="comment">Inact_target:   168316 kB</span></div>
<div class="line"><span class="comment">HighTotal:      131064 kB</span></div>
<div class="line"><span class="comment">HighFree:         1024 kB</span></div>
<div class="line"><span class="comment">LowTotal:       899492 kB</span></div>
<div class="line"><span class="comment">LowFree:        133732 kB</span></div>
<div class="line"><span class="comment">SwapTotal:     2096460 kB</span></div>
<div class="line"><span class="comment">SwapFree:      2085664 kB</span></div>
<div class="line"><span class="comment">Committed_AS:   348732 kB</span></div>
<div class="line"><span class="comment">        */</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Remember that this is client load, not db server load!</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    var $_lastLoad;</div>
<div class="line">    <span class="keyword">function</span> CPULoad()</div>
<div class="line">    {</div>
<div class="line">        $info = $this-&gt;_CPULoad();</div>
<div class="line">        <span class="keywordflow">if</span> (!$info) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(PHP_OS,<span class="stringliteral">&#39;WIN&#39;</span>,3)==0) {</div>
<div class="line">            <span class="keywordflow">return</span> (integer) $info[0];</div>
<div class="line">        }<span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> (empty($this-&gt;_lastLoad)) {</div>
<div class="line">                sleep(1);</div>
<div class="line">                $this-&gt;_lastLoad = $info;</div>
<div class="line">                $info = $this-&gt;_CPULoad();</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            $last = $this-&gt;_lastLoad;</div>
<div class="line">            $this-&gt;_lastLoad = $info;</div>
<div class="line"> </div>
<div class="line">            $d_user = $info[0] - $last[0];</div>
<div class="line">            $d_nice = $info[1] - $last[1];</div>
<div class="line">            $d_system = $info[2] - $last[2];</div>
<div class="line">            $d_idle = $info[3] - $last[3];</div>
<div class="line"> </div>
<div class="line">            <span class="comment">//printf(&quot;Delta - User: %f  Nice: %f  System: %f  Idle: %f&lt;br&gt;&quot;,$d_user,$d_nice,$d_system,$d_idle);</span></div>
<div class="line"> </div>
<div class="line">            $total=$d_user+$d_nice+$d_system+$d_idle;</div>
<div class="line">            <span class="keywordflow">if</span> ($total&lt;1) $total=1;</div>
<div class="line">            <span class="keywordflow">return</span> 100*($d_user+$d_nice+$d_system)/$total;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> Tracer($sql)</div>
<div class="line">    {</div>
<div class="line">        $perf_table = adodb_perf::table();</div>
<div class="line">        $saveE = $this-&gt;conn-&gt;fnExecute;</div>
<div class="line">        $this-&gt;conn-&gt;fnExecute = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        global $ADODB_FETCH_MODE;</div>
<div class="line">        $save = $ADODB_FETCH_MODE;</div>
<div class="line">        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;</div>
<div class="line">        <span class="keywordflow">if</span> ($this-&gt;conn-&gt;fetchMode !== <span class="keyword">false</span>) $savem = $this-&gt;conn-&gt;SetFetchMode(<span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">        $sqlq = $this-&gt;conn-&gt;qstr($sql);</div>
<div class="line">        $arr = $this-&gt;conn-&gt;GetArray(</div>
<div class="line"><span class="stringliteral">&quot;select count(*),tracer</span></div>
<div class="line"><span class="stringliteral">    from $perf_table where sql1=$sqlq</span></div>
<div class="line"><span class="stringliteral">    group by tracer</span></div>
<div class="line"><span class="stringliteral">    order by 1 desc&quot;</span>);</div>
<div class="line">        $s = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        <span class="keywordflow">if</span> ($arr) {</div>
<div class="line">            $s .= <span class="stringliteral">&#39;&lt;h3&gt;Scripts Affected&lt;/h3&gt;&#39;</span>;</div>
<div class="line">            <span class="keywordflow">foreach</span>($arr as $k) {</div>
<div class="line">                $s .= sprintf(<span class="stringliteral">&quot;%4d&quot;</span>,$k[0]).<span class="stringliteral">&#39; &amp;nbsp; &#39;</span>.strip_tags($k[1]).<span class="stringliteral">&#39;&lt;br&gt;&#39;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (isset($savem)) $this-&gt;conn-&gt;SetFetchMode($savem);</div>
<div class="line">        $ADODB_CACHE_MODE = $save;</div>
<div class="line">        $this-&gt;conn-&gt;fnExecute = $saveE;</div>
<div class="line">        <span class="keywordflow">return</span> $s;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Explain Plan for $sql.</span></div>
<div class="line"><span class="comment">        If only a snippet of the $sql is passed in, then $partial will hold the crc32 of the</span></div>
<div class="line"><span class="comment">            actual sql.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> Explain($sql,<a id="a3" name="a3"></a><a class="code hl_variable" href="../../dc/d71/group___imap___client.html#ga4927115ba2fb10567f7ea8241f6b1909">$partial</a>=<span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> InvalidSQL($numsql = 10)</div>
<div class="line">    {</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;sql&#39;</span>])) <span class="keywordflow">return</span>;</div>
<div class="line">        $s = <span class="stringliteral">&#39;&lt;h3&gt;Invalid SQL&lt;/h3&gt;&#39;</span>;</div>
<div class="line">        $saveE = $this-&gt;conn-&gt;fnExecute;</div>
<div class="line">        $this-&gt;conn-&gt;fnExecute = <span class="keyword">false</span>;</div>
<div class="line">        $perf_table = adodb_perf::table();</div>
<div class="line">        $rs = $this-&gt;conn-&gt;SelectLimit(<span class="stringliteral">&quot;select distinct count(*),sql1,tracer as error_msg from $perf_table where tracer like &#39;ERROR:%&#39; group by sql1,tracer order by 1 desc&quot;</span>,$numsql);<span class="comment">//,$numsql);</span></div>
<div class="line">        $this-&gt;conn-&gt;fnExecute = $saveE;</div>
<div class="line">        <span class="keywordflow">if</span> ($rs) {</div>
<div class="line">            $s .= rs2html($rs,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;p&gt;$this-&gt;helpurl. &quot;</span>.$this-&gt;conn-&gt;ErrorMsg().<span class="stringliteral">&quot;&lt;/p&gt;&quot;</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> $s;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        This script identifies the longest running SQL</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> _SuspiciousSQL($numsql = 10)</div>
<div class="line">    {</div>
<div class="line">        global $ADODB_FETCH_MODE;</div>
<div class="line"> </div>
<div class="line">            $perf_table = adodb_perf::table();</div>
<div class="line">            $saveE = $this-&gt;conn-&gt;fnExecute;</div>
<div class="line">            $this-&gt;conn-&gt;fnExecute = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;exps&#39;</span>]) &amp;&amp; isset($_GET[<span class="stringliteral">&#39;sql&#39;</span>])) {</div>
<div class="line">                <a class="code hl_variable" href="../../dc/d71/group___imap___client.html#ga4927115ba2fb10567f7ea8241f6b1909">$partial</a> = !empty($_GET[<span class="stringliteral">&#39;part&#39;</span>]);</div>
<div class="line">                echo <span class="stringliteral">&quot;&lt;a name=explain&gt;&lt;/a&gt;&quot;</span>.$this-&gt;Explain($_GET[<span class="stringliteral">&#39;sql&#39;</span>],<a class="code hl_variable" href="../../dc/d71/group___imap___client.html#ga4927115ba2fb10567f7ea8241f6b1909">$partial</a>).<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;sql&#39;</span>])) <span class="keywordflow">return</span>;</div>
<div class="line">            $sql1 = $this-&gt;sql1;</div>
<div class="line"> </div>
<div class="line">            $save = $ADODB_FETCH_MODE;</div>
<div class="line">            $ADODB_FETCH_MODE = ADODB_FETCH_NUM;</div>
<div class="line">            <span class="keywordflow">if</span> ($this-&gt;conn-&gt;fetchMode !== <span class="keyword">false</span>) $savem = $this-&gt;conn-&gt;SetFetchMode(<span class="keyword">false</span>);</div>
<div class="line">            <span class="comment">//$this-&gt;conn-&gt;debug=1;</span></div>
<div class="line">            $rs = $this-&gt;conn-&gt;SelectLimit(</div>
<div class="line">            <span class="stringliteral">&quot;select avg(timer) as avg_timer,$sql1,count(*),max(timer) as max_timer,min(timer) as min_timer</span></div>
<div class="line"><span class="stringliteral">                from $perf_table</span></div>
<div class="line"><span class="stringliteral">                where {$this-&gt;conn-&gt;upperCase}({$this-&gt;conn-&gt;substr}(sql0,1,5)) not in (&#39;DROP &#39;,&#39;INSER&#39;,&#39;COMMI&#39;,&#39;CREAT&#39;)</span></div>
<div class="line"><span class="stringliteral">                and (tracer is null or tracer not like &#39;ERROR:%&#39;)</span></div>
<div class="line"><span class="stringliteral">                group by sql1</span></div>
<div class="line"><span class="stringliteral">                order by 1 desc&quot;</span>,$numsql);</div>
<div class="line">            <span class="keywordflow">if</span> (isset($savem)) $this-&gt;conn-&gt;SetFetchMode($savem);</div>
<div class="line">            $ADODB_FETCH_MODE = $save;</div>
<div class="line">            $this-&gt;conn-&gt;fnExecute = $saveE;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (!$rs) <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;p&gt;$this-&gt;helpurl. &quot;</span>.$this-&gt;conn-&gt;ErrorMsg().<span class="stringliteral">&quot;&lt;/p&gt;&quot;</span>;</div>
<div class="line">            $s = <span class="stringliteral">&quot;&lt;h3&gt;Suspicious SQL&lt;/h3&gt;</span></div>
<div class="line"><span class="stringliteral">&lt;font size=1&gt;The following SQL have high average execution times&lt;/font&gt;&lt;br&gt;</span></div>
<div class="line"><span class="stringliteral">&lt;table border=1 bgcolor=white&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;Avg Time&lt;/b&gt;&lt;td&gt;&lt;b&gt;Count&lt;/b&gt;&lt;td&gt;&lt;b&gt;SQL&lt;/b&gt;&lt;td&gt;&lt;b&gt;Max&lt;/b&gt;&lt;td&gt;&lt;b&gt;Min&lt;/b&gt;&lt;/tr&gt;\n&quot;</span>;</div>
<div class="line">            $max = $this-&gt;maxLength;</div>
<div class="line">            <span class="keywordflow">while</span> (!$rs-&gt;EOF) {</div>
<div class="line">                $sql = $rs-&gt;fields[1];</div>
<div class="line">                $raw = urlencode($sql);</div>
<div class="line">                <span class="keywordflow">if</span> (strlen($raw)&gt;$max-100) {</div>
<div class="line">                    $sql2 = substr($sql,0,$max-500);</div>
<div class="line">                    $raw = urlencode($sql2).<span class="stringliteral">&#39;&amp;part=&#39;</span>.crc32($sql);</div>
<div class="line">                }</div>
<div class="line">                $prefix = <span class="stringliteral">&quot;&lt;a target=sql&quot;</span>.rand().<span class="stringliteral">&quot; href=\&quot;?hidem=1&amp;exps=1&amp;sql=&quot;</span>.$raw.<span class="stringliteral">&quot;&amp;x#explain\&quot;&gt;&quot;</span>;</div>
<div class="line">                $suffix = <span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>;</div>
<div class="line">                <span class="keywordflow">if</span> ($this-&gt;explain == <span class="keyword">false</span> || strlen($prefix)&gt;$max) {</div>
<div class="line">                    $suffix = <span class="stringliteral">&#39; ... &lt;i&gt;String too long for GET parameter: &#39;</span>.strlen($prefix).<span class="stringliteral">&#39;&lt;/i&gt;&#39;</span>;</div>
<div class="line">                    $prefix = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">                $s .= <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span>.adodb_round($rs-&gt;fields[0],6).<span class="stringliteral">&quot;&lt;td align=right&gt;&quot;</span>.$rs-&gt;fields[2].<span class="stringliteral">&quot;&lt;td&gt;&lt;font size=-1&gt;&quot;</span>.$prefix.htmlspecialchars($sql).$suffix.<span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>.</div>
<div class="line">                    <span class="stringliteral">&quot;&lt;td&gt;&quot;</span>.$rs-&gt;fields[3].<span class="stringliteral">&quot;&lt;td&gt;&quot;</span>.$rs-&gt;fields[4].<span class="stringliteral">&quot;&lt;/tr&gt;&quot;</span>;</div>
<div class="line">                $rs-&gt;MoveNext();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">return</span> $s.<span class="stringliteral">&quot;&lt;/table&gt;&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> CheckMemory()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> SuspiciousSQL($numsql=10)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> adodb_perf::_SuspiciousSQL($numsql);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> ExpensiveSQL($numsql=10)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> adodb_perf::_ExpensiveSQL($numsql);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        This reports the percentage of load on the instance due to the most</span></div>
<div class="line"><span class="comment">        expensive few SQL statements. Tuning these statements can often</span></div>
<div class="line"><span class="comment">        make huge improvements in overall system performance.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> _ExpensiveSQL($numsql = 10)</div>
<div class="line">    {</div>
<div class="line">        global $ADODB_FETCH_MODE;</div>
<div class="line"> </div>
<div class="line">            $perf_table = adodb_perf::table();</div>
<div class="line">            $saveE = $this-&gt;conn-&gt;fnExecute;</div>
<div class="line">            $this-&gt;conn-&gt;fnExecute = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;expe&#39;</span>]) &amp;&amp; isset($_GET[<span class="stringliteral">&#39;sql&#39;</span>])) {</div>
<div class="line">                <a class="code hl_variable" href="../../dc/d71/group___imap___client.html#ga4927115ba2fb10567f7ea8241f6b1909">$partial</a> = !empty($_GET[<span class="stringliteral">&#39;part&#39;</span>]);</div>
<div class="line">                echo <span class="stringliteral">&quot;&lt;a name=explain&gt;&lt;/a&gt;&quot;</span>.$this-&gt;Explain($_GET[<span class="stringliteral">&#39;sql&#39;</span>],<a class="code hl_variable" href="../../dc/d71/group___imap___client.html#ga4927115ba2fb10567f7ea8241f6b1909">$partial</a>).<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;sql&#39;</span>])) <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            $sql1 = $this-&gt;sql1;</div>
<div class="line">            $save = $ADODB_FETCH_MODE;</div>
<div class="line">            $ADODB_FETCH_MODE = ADODB_FETCH_NUM;</div>
<div class="line">            <span class="keywordflow">if</span> ($this-&gt;conn-&gt;fetchMode !== <span class="keyword">false</span>) $savem = $this-&gt;conn-&gt;SetFetchMode(<span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">            $rs = $this-&gt;conn-&gt;SelectLimit(</div>
<div class="line">            <span class="stringliteral">&quot;select sum(timer) as total,$sql1,count(*),max(timer) as max_timer,min(timer) as min_timer</span></div>
<div class="line"><span class="stringliteral">                from $perf_table</span></div>
<div class="line"><span class="stringliteral">                where {$this-&gt;conn-&gt;upperCase}({$this-&gt;conn-&gt;substr}(sql0,1,5))  not in (&#39;DROP &#39;,&#39;INSER&#39;,&#39;COMMI&#39;,&#39;CREAT&#39;)</span></div>
<div class="line"><span class="stringliteral">                and (tracer is null or tracer not like &#39;ERROR:%&#39;)</span></div>
<div class="line"><span class="stringliteral">                group by sql1</span></div>
<div class="line"><span class="stringliteral">                having count(*)&gt;1</span></div>
<div class="line"><span class="stringliteral">                order by 1 desc&quot;</span>,$numsql);</div>
<div class="line">            <span class="keywordflow">if</span> (isset($savem)) $this-&gt;conn-&gt;SetFetchMode($savem);</div>
<div class="line">            $this-&gt;conn-&gt;fnExecute = $saveE;</div>
<div class="line">            $ADODB_FETCH_MODE = $save;</div>
<div class="line">            <span class="keywordflow">if</span> (!$rs) <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;p&gt;$this-&gt;helpurl. &quot;</span>.$this-&gt;conn-&gt;ErrorMsg().<span class="stringliteral">&quot;&lt;/p&gt;&quot;</span>;</div>
<div class="line">            $s = <span class="stringliteral">&quot;&lt;h3&gt;Expensive SQL&lt;/h3&gt;</span></div>
<div class="line"><span class="stringliteral">&lt;font size=1&gt;Tuning the following SQL could reduce the server load substantially&lt;/font&gt;&lt;br&gt;</span></div>
<div class="line"><span class="stringliteral">&lt;table border=1 bgcolor=white&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;Load&lt;/b&gt;&lt;td&gt;&lt;b&gt;Count&lt;/b&gt;&lt;td&gt;&lt;b&gt;SQL&lt;/b&gt;&lt;td&gt;&lt;b&gt;Max&lt;/b&gt;&lt;td&gt;&lt;b&gt;Min&lt;/b&gt;&lt;/tr&gt;\n&quot;</span>;</div>
<div class="line">            $max = $this-&gt;maxLength;</div>
<div class="line">            <span class="keywordflow">while</span> (!$rs-&gt;EOF) {</div>
<div class="line">                $sql = $rs-&gt;fields[1];</div>
<div class="line">                $raw = urlencode($sql);</div>
<div class="line">                <span class="keywordflow">if</span> (strlen($raw)&gt;$max-100) {</div>
<div class="line">                    $sql2 = substr($sql,0,$max-500);</div>
<div class="line">                    $raw = urlencode($sql2).<span class="stringliteral">&#39;&amp;part=&#39;</span>.crc32($sql);</div>
<div class="line">                }</div>
<div class="line">                $prefix = <span class="stringliteral">&quot;&lt;a target=sqle&quot;</span>.rand().<span class="stringliteral">&quot; href=\&quot;?hidem=1&amp;expe=1&amp;sql=&quot;</span>.$raw.<span class="stringliteral">&quot;&amp;x#explain\&quot;&gt;&quot;</span>;</div>
<div class="line">                $suffix = <span class="stringliteral">&quot;&lt;/a&gt;&quot;</span>;</div>
<div class="line">                <span class="keywordflow">if</span>($this-&gt;explain == <span class="keyword">false</span> || strlen($prefix&gt;$max)) {</div>
<div class="line">                    $prefix = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">                    $suffix = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">                }</div>
<div class="line">                $s .= <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span>.adodb_round($rs-&gt;fields[0],6).<span class="stringliteral">&quot;&lt;td align=right&gt;&quot;</span>.$rs-&gt;fields[2].<span class="stringliteral">&quot;&lt;td&gt;&lt;font size=-1&gt;&quot;</span>.$prefix.htmlspecialchars($sql).$suffix.<span class="stringliteral">&quot;&lt;/font&gt;&quot;</span>.</div>
<div class="line">                    <span class="stringliteral">&quot;&lt;td&gt;&quot;</span>.$rs-&gt;fields[3].<span class="stringliteral">&quot;&lt;td&gt;&quot;</span>.$rs-&gt;fields[4].<span class="stringliteral">&quot;&lt;/tr&gt;&quot;</span>;</div>
<div class="line">                $rs-&gt;MoveNext();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">return</span> $s.<span class="stringliteral">&quot;&lt;/table&gt;&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Raw function to return parameter value from $settings.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> DBParameter($param)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (empty($this-&gt;settings[$param])) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        $sql = $this-&gt;settings[$param][1];</div>
<div class="line">        <span class="keywordflow">return</span> $this-&gt;_DBParameter($sql);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Raw function returning array of poll parameters</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> PollParameters()</div>
<div class="line">    {</div>
<div class="line">        $arr[0] = (float)$this-&gt;DBParameter(<span class="stringliteral">&#39;data cache hit ratio&#39;</span>);</div>
<div class="line">        $arr[1] = (float)$this-&gt;DBParameter(<span class="stringliteral">&#39;data reads&#39;</span>);</div>
<div class="line">        $arr[2] = (float)$this-&gt;DBParameter(<span class="stringliteral">&#39;data writes&#39;</span>);</div>
<div class="line">        $arr[3] = (integer) $this-&gt;DBParameter(<span class="stringliteral">&#39;current connections&#39;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> $arr;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Low-level Get Database Parameter</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> _DBParameter($sql)</div>
<div class="line">    {</div>
<div class="line">        $savelog = $this-&gt;conn-&gt;LogSQL(<span class="keyword">false</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (is_array($sql)) {</div>
<div class="line">        global $ADODB_FETCH_MODE;</div>
<div class="line"> </div>
<div class="line">            $sql1 = $sql[0];</div>
<div class="line">            <a id="a4" name="a4"></a><a class="code hl_variable" href="../../d9/d9d/group___crypt___blowfish.html#gaf1b7751b6c09e2d3124df5828a7b6490">$key</a> = $sql[1];</div>
<div class="line">            <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($sql)&gt;2) $pos = $sql[2];</div>
<div class="line">            <span class="keywordflow">else</span> $pos = 1;</div>
<div class="line">            <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($sql)&gt;3) $coef = $sql[3];</div>
<div class="line">            <span class="keywordflow">else</span> $coef = <span class="keyword">false</span>;</div>
<div class="line">            $ret = <span class="keyword">false</span>;</div>
<div class="line">            $save = $ADODB_FETCH_MODE;</div>
<div class="line">            $ADODB_FETCH_MODE = ADODB_FETCH_NUM;</div>
<div class="line">            <span class="keywordflow">if</span> ($this-&gt;conn-&gt;fetchMode !== <span class="keyword">false</span>) $savem = $this-&gt;conn-&gt;SetFetchMode(<span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">            $rs = $this-&gt;conn-&gt;Execute($sql1);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (isset($savem)) $this-&gt;conn-&gt;SetFetchMode($savem);</div>
<div class="line">            $ADODB_FETCH_MODE = $save;</div>
<div class="line">            <span class="keywordflow">if</span> ($rs) {</div>
<div class="line">                <span class="keywordflow">while</span> (!$rs-&gt;EOF) {</div>
<div class="line">                    $keyf = <a class="code hl_function" href="../../dc/d71/group___imap___client.html#ga4a20559544fdf4dcb457e258dc976cf8">reset</a>($rs-&gt;fields);</div>
<div class="line">                    <span class="keywordflow">if</span> (trim($keyf) == <a class="code hl_variable" href="../../d9/d9d/group___crypt___blowfish.html#gaf1b7751b6c09e2d3124df5828a7b6490">$key</a>) {</div>
<div class="line">                        $ret = $rs-&gt;fields[$pos];</div>
<div class="line">                        <span class="keywordflow">if</span> ($coef) $ret *= $coef;</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                    $rs-&gt;MoveNext();</div>
<div class="line">                }</div>
<div class="line">                $rs-&gt;Close();</div>
<div class="line">            }</div>
<div class="line">            $this-&gt;conn-&gt;LogSQL($savelog);</div>
<div class="line">            <span class="keywordflow">return</span> $ret;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> (strncmp($sql,<span class="charliteral">&#39;=&#39;</span>,1) == 0) {</div>
<div class="line">                $fn = substr($sql,1);</div>
<div class="line">                <span class="keywordflow">return</span> $this-&gt;$fn();</div>
<div class="line">            }</div>
<div class="line">            $sql = str_replace(<span class="stringliteral">&#39;$DATABASE&#39;</span>,$this-&gt;conn-&gt;database,$sql);</div>
<div class="line">            $ret = $this-&gt;conn-&gt;GetOne($sql);</div>
<div class="line">            $this-&gt;conn-&gt;LogSQL($savelog);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">return</span> $ret;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Warn if cache ratio falls below threshold. Displayed in &quot;Description&quot; column.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> WarnCacheRatio($val)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> ($val &lt; $this-&gt;warnRatio)</div>
<div class="line">             <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;font color=red&gt;&lt;b&gt;Cache ratio should be at least &#39;</span>.$this-&gt;warnRatio.<span class="stringliteral">&#39;%&lt;/b&gt;&lt;/font&gt;&#39;</span>;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> clearsql()</div>
<div class="line">    {</div>
<div class="line">        $perf_table = adodb_perf::table();</div>
<div class="line">        $this-&gt;conn-&gt;Execute(<span class="stringliteral">&quot;delete from $perf_table where created&lt;&quot;</span>.$this-&gt;conn-&gt;sysTimeStamp);</div>
<div class="line">    }</div>
<div class="line"><span class="comment">    /***********************************************************************************************/</span></div>
<div class="line">    <span class="comment">//                                    HIGH LEVEL UI FUNCTIONS</span></div>
<div class="line"><span class="comment">    /***********************************************************************************************/</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> UI($pollsecs=5)</div>
<div class="line">    {</div>
<div class="line">    global $ADODB_LOG_CONN;</div>
<div class="line"> </div>
<div class="line">    $perf_table = adodb_perf::table();</div>
<div class="line">    $conn = $this-&gt;conn;</div>
<div class="line"> </div>
<div class="line">    $app = $conn-&gt;host;</div>
<div class="line">    <span class="keywordflow">if</span> ($conn-&gt;host &amp;&amp; $conn-&gt;database) $app .= <span class="stringliteral">&#39;, db=&#39;</span>;</div>
<div class="line">    $app .= $conn-&gt;database;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($app) $app .= <span class="stringliteral">&#39;, &#39;</span>;</div>
<div class="line">    $savelog = $this-&gt;conn-&gt;LogSQL(<span class="keyword">false</span>);</div>
<div class="line">    $info = $conn-&gt;ServerInfo();</div>
<div class="line">    <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;clearsql&#39;</span>])) {</div>
<div class="line">        $this-&gt;clearsql();</div>
<div class="line">    }</div>
<div class="line">    $this-&gt;conn-&gt;LogSQL($savelog);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!isset($_SESSION[<span class="stringliteral">&#39;ADODB_PERF_SQL&#39;</span>])) $nsql = $_SESSION[<span class="stringliteral">&#39;ADODB_PERF_SQL&#39;</span>] = 10;</div>
<div class="line">    <span class="keywordflow">else</span>  $nsql = $_SESSION[<span class="stringliteral">&#39;ADODB_PERF_SQL&#39;</span>];</div>
<div class="line"> </div>
<div class="line">    $app .= $info[<span class="stringliteral">&#39;description&#39;</span>];</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;do&#39;</span>])) $do = $_GET[<span class="stringliteral">&#39;do&#39;</span>];</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">&#39;do&#39;</span>])) $do = $_POST[<span class="stringliteral">&#39;do&#39;</span>];</div>
<div class="line">     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;sql&#39;</span>])) $do = <span class="stringliteral">&#39;viewsql&#39;</span>;</div>
<div class="line">     <span class="keywordflow">else</span> $do = <span class="stringliteral">&#39;stats&#39;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;nsql&#39;</span>])) {</div>
<div class="line">        <span class="keywordflow">if</span> ($_GET[<span class="stringliteral">&#39;nsql&#39;</span>] &gt; 0) $nsql = $_SESSION[<span class="stringliteral">&#39;ADODB_PERF_SQL&#39;</span>] = (integer) $_GET[<span class="stringliteral">&#39;nsql&#39;</span>];</div>
<div class="line">    }</div>
<div class="line">    echo <span class="stringliteral">&quot;&lt;title&gt;ADOdb Performance Monitor on $app&lt;/title&gt;&lt;body bgcolor=white&gt;&quot;</span>;</div>
<div class="line">    <span class="keywordflow">if</span> ($do == <span class="stringliteral">&#39;viewsql&#39;</span>) $form = <span class="stringliteral">&quot;&lt;td&gt;&lt;form&gt;# SQL:&lt;input type=hidden value=viewsql name=do&gt; &lt;input type=text size=4 name=nsql value=$nsql&gt;&lt;input type=submit value=Go&gt;&lt;/td&gt;&lt;/form&gt;&quot;</span>;</div>
<div class="line">    <span class="keywordflow">else</span> $form = <span class="stringliteral">&quot;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    $allowsql = !<a class="code hl_variable" href="../../d0/de1/group__core.html#ga4806e88f79ea3f4220bb2e1bc67ed1a2">defined</a>(<span class="stringliteral">&#39;ADODB_PERF_NO_RUN_SQL&#39;</span>);</div>
<div class="line">    global $ADODB_PERF_MIN;</div>
<div class="line">    $app .= <span class="stringliteral">&quot; (Min sql timing \$ADODB_PERF_MIN=$ADODB_PERF_MIN secs)&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>  (empty($_GET[<span class="stringliteral">&#39;hidem&#39;</span>]))</div>
<div class="line">    echo <span class="stringliteral">&quot;&lt;table border=1 width=100% bgcolor=lightyellow&gt;&lt;tr&gt;&lt;td colspan=2&gt;</span></div>
<div class="line"><span class="stringliteral">    &lt;b&gt;&lt;a href=https://adodb.org/dokuwiki/doku.php?id=v5:performance:performance_index&gt;ADOdb&lt;/a&gt; Performance Monitor&lt;/b&gt; &lt;font size=1&gt;for $app&lt;/font&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;</span></div>
<div class="line"><span class="stringliteral">    &lt;a href=?do=stats&gt;&lt;b&gt;Performance Stats&lt;/b&gt;&lt;/a&gt; &amp;nbsp; &lt;a href=?do=viewsql&gt;&lt;b&gt;View SQL&lt;/b&gt;&lt;/a&gt;</span></div>
<div class="line"><span class="stringliteral">     &amp;nbsp; &lt;a href=?do=tables&gt;&lt;b&gt;View Tables&lt;/b&gt;&lt;/a&gt; &amp;nbsp; &lt;a href=?do=poll&gt;&lt;b&gt;Poll Stats&lt;/b&gt;&lt;/a&gt;&quot;</span>,</div>
<div class="line">     $allowsql ? <span class="stringliteral">&#39; &amp;nbsp; &lt;a href=?do=dosql&gt;&lt;b&gt;Run SQL&lt;/b&gt;&lt;/a&gt;&#39;</span> : <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line">     <span class="stringliteral">&quot;$form&quot;</span>,</div>
<div class="line">     <span class="stringliteral">&quot;&lt;/tr&gt;&lt;/table&gt;&quot;</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">switch</span> ($do) {</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">case</span> <span class="stringliteral">&#39;stats&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (empty($ADODB_LOG_CONN))</div>
<div class="line">                echo <span class="stringliteral">&quot;&lt;p&gt;&amp;nbsp; &lt;a href=\&quot;?do=viewsql&amp;clearsql=1\&quot;&gt;Clear SQL Log&lt;/a&gt;&lt;br&gt;&quot;</span>;</div>
<div class="line">            echo $this-&gt;HealthCheck();</div>
<div class="line">            <span class="comment">//$this-&gt;conn-&gt;debug=1;</span></div>
<div class="line">            echo $this-&gt;CheckMemory();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="stringliteral">&#39;poll&#39;</span>:</div>
<div class="line">            $self = htmlspecialchars($_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]);</div>
<div class="line">            echo <span class="stringliteral">&quot;&lt;iframe width=720 height=80%</span></div>
<div class="line"><span class="stringliteral">                src=\&quot;{$self}?do=poll2&amp;hidem=1\&quot;&gt;&lt;/iframe&gt;&quot;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="stringliteral">&#39;poll2&#39;</span>:</div>
<div class="line">            echo <span class="stringliteral">&quot;&lt;pre&gt;&quot;</span>;</div>
<div class="line">            $this-&gt;Poll($pollsecs);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> <span class="stringliteral">&#39;dosql&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (!$allowsql) <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">            $this-&gt;DoSQLForm();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="stringliteral">&#39;viewsql&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (empty($_GET[<span class="stringliteral">&#39;hidem&#39;</span>]))</div>
<div class="line">                echo <span class="stringliteral">&quot;&amp;nbsp; &lt;a href=\&quot;?do=viewsql&amp;clearsql=1\&quot;&gt;Clear SQL Log&lt;/a&gt;&lt;br&gt;&quot;</span>;</div>
<div class="line">            echo($this-&gt;SuspiciousSQL($nsql));</div>
<div class="line">            echo($this-&gt;ExpensiveSQL($nsql));</div>
<div class="line">            echo($this-&gt;InvalidSQL($nsql));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="stringliteral">&#39;tables&#39;</span>:</div>
<div class="line">            echo $this-&gt;Tables(); <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        global $ADODB_vers;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Runs in infinite loop, returning real-time statistics</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> Poll($secs=5)</div>
<div class="line">    {</div>
<div class="line">        $this-&gt;conn-&gt;fnExecute = <span class="keyword">false</span>;</div>
<div class="line">        <span class="comment">//$this-&gt;conn-&gt;debug=1;</span></div>
<div class="line">        <span class="keywordflow">if</span> ($secs &lt;= 1) $secs = 1;</div>
<div class="line">        echo <span class="stringliteral">&quot;Accumulating statistics, every $secs seconds...\n&quot;</span>;<a class="code hl_function" href="../../d7/d02/group__tool__log.html#ga7543e29bf5065f86f5b6ec5145aacc77">flush</a>();</div>
<div class="line">        $arro = $this-&gt;PollParameters();</div>
<div class="line">        $cnt = 0;</div>
<div class="line">        set_time_limit(0);</div>
<div class="line">        sleep($secs);</div>
<div class="line">        <span class="keywordflow">while</span> (1) {</div>
<div class="line"> </div>
<div class="line">            $arr = $this-&gt;PollParameters();</div>
<div class="line"> </div>
<div class="line">            $hits   = sprintf(<span class="stringliteral">&#39;%2.2f&#39;</span>,$arr[0]);</div>
<div class="line">            $reads  = sprintf(<span class="stringliteral">&#39;%12.4f&#39;</span>,($arr[1]-$arro[1])/$secs);</div>
<div class="line">            $writes = sprintf(<span class="stringliteral">&#39;%12.4f&#39;</span>,($arr[2]-$arro[2])/$secs);</div>
<div class="line">            $sess = sprintf(<span class="stringliteral">&#39;%5d&#39;</span>,$arr[3]);</div>
<div class="line"> </div>
<div class="line">            $load = $this-&gt;CPULoad();</div>
<div class="line">            <span class="keywordflow">if</span> ($load !== <span class="keyword">false</span>) {</div>
<div class="line">                $oslabel = <span class="stringliteral">&#39;WS-CPU%&#39;</span>;</div>
<div class="line">                $osval = sprintf(<span class="stringliteral">&quot; %2.1f  &quot;</span>,(<span class="keywordtype">float</span>) $load);</div>
<div class="line">            }<span class="keywordflow">else</span> {</div>
<div class="line">                $oslabel = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">                $osval = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> ($cnt % 10 == 0) echo <span class="stringliteral">&quot; Time   &quot;</span>.$oslabel.<span class="stringliteral">&quot;   Hit%   Sess           Reads/s          Writes/s\n&quot;</span>;</div>
<div class="line">            $cnt += 1;</div>
<div class="line">            echo date(<span class="stringliteral">&#39;H:i:s&#39;</span>).<span class="stringliteral">&#39;  &#39;</span>.$osval.<span class="stringliteral">&quot;$hits  $sess $reads $writes\n&quot;</span>;</div>
<div class="line">            <a class="code hl_function" href="../../d7/d02/group__tool__log.html#ga7543e29bf5065f86f5b6ec5145aacc77">flush</a>();</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (connection_aborted()) <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            sleep($secs);</div>
<div class="line">            $arro = $arr;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Returns basic health check in a command line interface</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> HealthCheckCLI()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> $this-&gt;HealthCheck(<span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">        Returns basic health check as HTML</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keyword">function</span> HealthCheck($cli=<span class="keyword">false</span>)</div>
<div class="line">    {</div>
<div class="line">        $saveE = $this-&gt;conn-&gt;fnExecute;</div>
<div class="line">        $this-&gt;conn-&gt;fnExecute = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span> ($cli) $html = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        <span class="keywordflow">else</span> $html = $this-&gt;table.<span class="stringliteral">&#39;&lt;tr&gt;&lt;td colspan=3&gt;&lt;h3&gt;&#39;</span>.$this-&gt;conn-&gt;databaseType.<span class="stringliteral">&#39;&lt;/h3&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>.$this-&gt;titles;</div>
<div class="line"> </div>
<div class="line">        $oldc = <span class="keyword">false</span>;</div>
<div class="line">        $bgc = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">        <span class="keywordflow">foreach</span>($this-&gt;settings as $name =&gt; $arr) {</div>
<div class="line">            <span class="keywordflow">if</span> ($arr === <span class="keyword">false</span>) <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (!is_string($name)) {</div>
<div class="line">                <span class="keywordflow">if</span> ($cli) $html .= <span class="stringliteral">&quot; -- $arr -- \n&quot;</span>;</div>
<div class="line">                <span class="keywordflow">else</span> $html .= <span class="stringliteral">&quot;&lt;tr bgcolor=$this-&gt;color&gt;&lt;td colspan=3&gt;&lt;i&gt;$arr&lt;/i&gt; &amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;</span>;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (!is_array($arr)) <span class="keywordflow">break</span>;</div>
<div class="line">            $category = $arr[0];</div>
<div class="line">            $how = $arr[1];</div>
<div class="line">            <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($arr)&gt;2) $desc = $arr[2];</div>
<div class="line">            <span class="keywordflow">else</span> $desc = <span class="stringliteral">&#39; &amp;nbsp; &#39;</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> ($category == <span class="stringliteral">&#39;HIDE&#39;</span>) <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">            $val = $this-&gt;_DBParameter($how);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> ($desc &amp;&amp; strncmp($desc,<span class="stringliteral">&quot;=&quot;</span>,1) === 0) {</div>
<div class="line">                $fn = substr($desc,1);</div>
<div class="line">                $desc = $this-&gt;$fn($val);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> ($val === <span class="keyword">false</span>) {</div>
<div class="line">                $m = $this-&gt;conn-&gt;ErrorMsg();</div>
<div class="line">                $val = <span class="stringliteral">&quot;Error: $m&quot;</span>;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">if</span> (is_numeric($val) &amp;&amp; $val &gt;= 256*1024) {</div>
<div class="line">                    <span class="keywordflow">if</span> ($val % (1024*1024) == 0) {</div>
<div class="line">                        $val /= (1024*1024);</div>
<div class="line">                        $val .= <span class="charliteral">&#39;M&#39;</span>;</div>
<div class="line">                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($val % 1024 == 0) {</div>
<div class="line">                        $val /= 1024;</div>
<div class="line">                        $val .= <span class="charliteral">&#39;K&#39;</span>;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="comment">//$val = htmlspecialchars($val);</span></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> ($category != $oldc) {</div>
<div class="line">                $oldc = $category;</div>
<div class="line">                <span class="comment">//$bgc = ($bgc == &#39; bgcolor=&#39;.$this-&gt;color) ? &#39; bgcolor=white&#39; : &#39; bgcolor=&#39;.$this-&gt;color;</span></div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (strlen($desc)==0) $desc = <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (strlen($val)==0) $val = <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;</div>
<div class="line">            <span class="keywordflow">if</span> ($cli) {</div>
<div class="line">                $html  .= str_replace(<span class="stringliteral">&#39;&amp;nbsp;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,sprintf($this-&gt;cliFormat,strip_tags($name),strip_tags($val),strip_tags($desc)));</div>
<div class="line"> </div>
<div class="line">            }<span class="keywordflow">else</span> {</div>
<div class="line">                $html .= <span class="stringliteral">&quot;&lt;tr$bgc&gt;&lt;td&gt;&quot;</span>.$name.<span class="stringliteral">&#39;&lt;/td&gt;&lt;td&gt;&#39;</span>.$val.<span class="stringliteral">&#39;&lt;/td&gt;&lt;td&gt;&#39;</span>.$desc.<span class="stringliteral">&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!$cli) $html .= <span class="stringliteral">&quot;&lt;/table&gt;\n&quot;</span>;</div>
<div class="line">        $this-&gt;conn-&gt;fnExecute = $saveE;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> $html;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> Tables($orderby=<span class="charliteral">&#39;1&#39;</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!$this-&gt;tablesSQL) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        $savelog = $this-&gt;conn-&gt;LogSQL(<span class="keyword">false</span>);</div>
<div class="line">        $rs = $this-&gt;conn-&gt;Execute($this-&gt;tablesSQL.<span class="stringliteral">&#39; order by &#39;</span>.$orderby);</div>
<div class="line">        $this-&gt;conn-&gt;LogSQL($savelog);</div>
<div class="line">        $html = rs2html($rs,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div>
<div class="line">        <span class="keywordflow">return</span> $html;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> CreateLogTable()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (!$this-&gt;createTableSQL) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        $table = $this-&gt;table();</div>
<div class="line">        $sql = str_replace(<span class="stringliteral">&#39;adodb_logsql&#39;</span>,$table,$this-&gt;createTableSQL);</div>
<div class="line">        $savelog = $this-&gt;conn-&gt;LogSQL(<span class="keyword">false</span>);</div>
<div class="line">        $ok = $this-&gt;conn-&gt;Execute($sql);</div>
<div class="line">        $this-&gt;conn-&gt;LogSQL($savelog);</div>
<div class="line">        <span class="keywordflow">return</span> ($ok) ? true : <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> DoSQLForm()</div>
<div class="line">    {</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        $PHP_SELF = htmlspecialchars($_SERVER[<span class="stringliteral">&#39;PHP_SELF&#39;</span>]);</div>
<div class="line">        $sql = isset($_REQUEST[<span class="stringliteral">&#39;sql&#39;</span>]) ? $_REQUEST[<span class="stringliteral">&#39;sql&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (isset($_SESSION[<span class="stringliteral">&#39;phplens_sqlrows&#39;</span>])) $rows = $_SESSION[<span class="stringliteral">&#39;phplens_sqlrows&#39;</span>];</div>
<div class="line">        <span class="keywordflow">else</span> $rows = 3;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (isset($_REQUEST[<span class="stringliteral">&#39;SMALLER&#39;</span>])) {</div>
<div class="line">            $rows /= 2;</div>
<div class="line">            <span class="keywordflow">if</span> ($rows &lt; 3) $rows = 3;</div>
<div class="line">            $_SESSION[<span class="stringliteral">&#39;phplens_sqlrows&#39;</span>] = $rows;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (isset($_REQUEST[<span class="stringliteral">&#39;BIGGER&#39;</span>])) {</div>
<div class="line">            $rows *= 2;</div>
<div class="line">            $_SESSION[<span class="stringliteral">&#39;phplens_sqlrows&#39;</span>] = $rows;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">?&gt;</div>
<div class="line"> </div>
<div class="line">&lt;form method=<span class="stringliteral">&quot;POST&quot;</span> action=<span class="stringliteral">&quot;&lt;?php echo $PHP_SELF ?&gt;&quot;</span>&gt;</div>
<div class="line">&lt;table&gt;&lt;tr&gt;</div>
<div class="line">&lt;td&gt; Form size: &lt;input type=<span class="stringliteral">&quot;submit&quot;</span> <a id="a5" name="a5"></a><a class="code hl_function" href="../../d8/ded/group___simple_pie.html#gaefbfa229f1c9e1fc967bff724a010f9e">value</a>=<span class="stringliteral">&quot; &amp;lt; &quot;</span> name=<span class="stringliteral">&quot;SMALLER&quot;</span>&gt;&lt;input type=<span class="stringliteral">&quot;submit&quot;</span> <a class="code hl_function" href="../../d8/ded/group___simple_pie.html#gaefbfa229f1c9e1fc967bff724a010f9e">value</a>=<span class="stringliteral">&quot; &amp;gt; &amp;gt; &quot;</span> name=<span class="stringliteral">&quot;BIGGER&quot;</span>&gt;</div>
<div class="line">&lt;/td&gt;</div>
<div class="line">&lt;td align=right&gt;</div>
<div class="line">&lt;input type=<span class="stringliteral">&quot;submit&quot;</span> <a class="code hl_function" href="../../d8/ded/group___simple_pie.html#gaefbfa229f1c9e1fc967bff724a010f9e">value</a>=<span class="stringliteral">&quot; Run SQL Below &quot;</span> name=<span class="stringliteral">&quot;RUN&quot;</span>&gt;&lt;input type=hidden name=<span class="keywordflow">do</span> <a class="code hl_function" href="../../d8/ded/group___simple_pie.html#gaefbfa229f1c9e1fc967bff724a010f9e">value</a>=dosql&gt;</div>
<div class="line">&lt;/td&gt;&lt;/tr&gt;</div>
<div class="line">  &lt;tr&gt;</div>
<div class="line">  &lt;td colspan=2&gt;&lt;textarea rows=&lt;?php print $rows; ?&gt; name=<span class="stringliteral">&quot;sql&quot;</span> cols=<span class="stringliteral">&quot;80&quot;</span>&gt;&lt;?php print htmlspecialchars($sql) ?&gt;&lt;/textarea&gt;</div>
<div class="line">  &lt;/td&gt;</div>
<div class="line">  &lt;/tr&gt;</div>
<div class="line"> &lt;/table&gt;</div>
<div class="line">&lt;/form&gt;</div>
<div class="line"> </div>
<div class="line">&lt;?php</div>
<div class="line">        <span class="keywordflow">if</span> (!isset($_REQUEST[<span class="stringliteral">&#39;sql&#39;</span>])) <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        $sql = trim($sql);</div>
<div class="line">        <span class="keywordflow">if</span> (substr($sql,strlen($sql)-1) === <span class="charliteral">&#39;;&#39;</span>) {</div>
<div class="line">            $print = <span class="keyword">true</span>;</div>
<div class="line">            $sqla = $this-&gt;SplitSQL($sql);</div>
<div class="line">        } <span class="keywordflow">else</span>  {</div>
<div class="line">            $print = <span class="keyword">false</span>;</div>
<div class="line">            $sqla = <a class="code hl_namespace" href="../../d7/df9/namespacearray.html">array</a>($sql);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">foreach</span>($sqla as $sqls) {</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (!$sqls) <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> ($print) {</div>
<div class="line">                print <span class="stringliteral">&quot;&lt;p&gt;&quot;</span>.htmlspecialchars($sqls).<span class="stringliteral">&quot;&lt;/p&gt;&quot;</span>;</div>
<div class="line">                <a class="code hl_function" href="../../d7/d02/group__tool__log.html#ga7543e29bf5065f86f5b6ec5145aacc77">flush</a>();</div>
<div class="line">            }</div>
<div class="line">            $savelog = $this-&gt;conn-&gt;LogSQL(<span class="keyword">false</span>);</div>
<div class="line">            $rs = $this-&gt;conn-&gt;Execute($sqls);</div>
<div class="line">            $this-&gt;conn-&gt;LogSQL($savelog);</div>
<div class="line">            <span class="keywordflow">if</span> ($rs &amp;&amp; is_object($rs) &amp;&amp; !$rs-&gt;EOF) {</div>
<div class="line">                rs2html($rs);</div>
<div class="line">                <span class="keywordflow">while</span> ($rs-&gt;NextRecordSet()) {</div>
<div class="line">                    print <span class="stringliteral">&quot;&lt;table width=98% bgcolor=#C0C0FF&gt;&lt;tr&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;</span>;</div>
<div class="line">                    rs2html($rs);</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                $e1 = (integer) $this-&gt;conn-&gt;ErrorNo();</div>
<div class="line">                $e2 = $this-&gt;conn-&gt;ErrorMsg();</div>
<div class="line">                <span class="keywordflow">if</span> (($e1) || ($e2)) {</div>
<div class="line">                    <span class="keywordflow">if</span> (empty($e1)) $e1 = <span class="stringliteral">&#39;-1&#39;</span>; <span class="comment">// postgresql fix</span></div>
<div class="line">                    print <span class="stringliteral">&#39; &amp;nbsp; &#39;</span>.$e1.<span class="stringliteral">&#39;: &#39;</span>.$e2;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    print <span class="stringliteral">&quot;&lt;p&gt;No Recordset returned&lt;br&gt;&lt;/p&gt;&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        } <span class="comment">// foreach</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> SplitSQL($sql)</div>
<div class="line">    {</div>
<div class="line">        $arr = explode(<span class="charliteral">&#39;;&#39;</span>,$sql);</div>
<div class="line">        <span class="keywordflow">return</span> $arr;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="comment">   /************************************************************************/</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> OptimizeTables()</div>
<div class="line">    {</div>
<div class="line">        $args = func_get_args();</div>
<div class="line">        $numArgs = func_num_args();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ( $numArgs == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        $mode = ADODB_OPT_LOW;</div>
<div class="line">        $lastArg = $args[ $numArgs - 1];</div>
<div class="line">        <span class="keywordflow">if</span> ( !is_string($lastArg)) {</div>
<div class="line">            $mode = $lastArg;</div>
<div class="line">            unset( $args[ $numArgs - 1]);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">foreach</span>( $args as $table) {</div>
<div class="line">            $this-&gt;optimizeTable( $table, $mode);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> <a id="a6" name="a6"></a><a class="code hl_function" href="../../de/d06/classadodb__perf.html#ad4f9952aee2039976255eed5c577354f">OptimizeTable</a>( $table, $mode = ADODB_OPT_LOW)</div>
<div class="line">    {</div>
<div class="line">        ADOConnection::outp( sprintf( <span class="stringliteral">&quot;&lt;p&gt;%s: &#39;%s&#39; not implemented for driver &#39;%s&#39;&lt;/p&gt;&quot;</span>, __CLASS__, __FUNCTION__, $this-&gt;conn-&gt;databaseType));</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">function</span> <a id="a7" name="a7"></a><a class="code hl_function" href="../../de/d06/classadodb__perf.html#a66be832c08d14e3af1eb2772f917403c">optimizeDatabase</a>()</div>
<div class="line">    {</div>
<div class="line">        $conn = $this-&gt;conn;</div>
<div class="line">        <span class="keywordflow">if</span> ( !$conn) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        $tables = $conn-&gt;MetaTables( <span class="stringliteral">&#39;TABLES&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> ( !$tables ) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">foreach</span>( $tables as $table) {</div>
<div class="line">            <span class="keywordflow">if</span> ( !$this-&gt;optimizeTable( $table)) {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// end hack</span></div>
<div class="line">}</div>
<div class="ttc" id="aclass_exception_html"><div class="ttname"><a href="../../df/d70/class_exception.html">Exception</a></div><div class="ttdef"><b>Definition</b> Exception.php:27</div></div>
<div class="ttc" id="aclassadodb__perf_html"><div class="ttname"><a href="../../de/d06/classadodb__perf.html">adodb_perf</a></div><div class="ttdef"><b>Definition</b> adodb-perf.inc.php:225</div></div>
<div class="ttc" id="aclassadodb__perf_html_a66be832c08d14e3af1eb2772f917403c"><div class="ttname"><a href="../../de/d06/classadodb__perf.html#a66be832c08d14e3af1eb2772f917403c">adodb_perf\optimizeDatabase</a></div><div class="ttdeci">optimizeDatabase()</div><div class="ttdoc">Reorganise current database.</div><div class="ttdef"><b>Definition</b> adodb-perf.inc.php:1063</div></div>
<div class="ttc" id="aclassadodb__perf_html_ad4f9952aee2039976255eed5c577354f"><div class="ttname"><a href="../../de/d06/classadodb__perf.html#ad4f9952aee2039976255eed5c577354f">adodb_perf\OptimizeTable</a></div><div class="ttdeci">OptimizeTable( $table, $mode=ADODB_OPT_LOW)</div><div class="ttdoc">Reorganise the table-indices/statistics/.</div><div class="ttdef"><b>Definition</b> adodb-perf.inc.php:1049</div></div>
<div class="ttc" id="agroup___crypt___blowfish_html_gaf1b7751b6c09e2d3124df5828a7b6490"><div class="ttname"><a href="../../d9/d9d/group___crypt___blowfish.html#gaf1b7751b6c09e2d3124df5828a7b6490">$key</a></div><div class="ttdeci">string $key</div><div class="ttdoc">Encryption key.</div><div class="ttdef"><b>Definition</b> Base.php:44</div></div>
<div class="ttc" id="agroup___imap___client_html_ga4927115ba2fb10567f7ea8241f6b1909"><div class="ttname"><a href="../../dc/d71/group___imap___client.html#ga4927115ba2fb10567f7ea8241f6b1909">$partial</a></div><div class="ttdeci">string $partial</div><div class="ttdoc">A byte range for use with IMAP FETCH.</div><div class="ttdef"><b>Definition</b> Url.php:56</div></div>
<div class="ttc" id="agroup___imap___client_html_ga4a20559544fdf4dcb457e258dc976cf8"><div class="ttname"><a href="../../dc/d71/group___imap___client.html#ga4a20559544fdf4dcb457e258dc976cf8">reset</a></div><div class="ttdeci">reset()</div><div class="ttdoc">Reset the mailbox information.</div><div class="ttdef"><b>Definition</b> Mailbox.php:171</div></div>
<div class="ttc" id="agroup___simple_pie_html_gaefbfa229f1c9e1fc967bff724a010f9e"><div class="ttname"><a href="../../d8/ded/group___simple_pie.html#gaefbfa229f1c9e1fc967bff724a010f9e">value</a></div><div class="ttdeci">value()</div><div class="ttdoc">See what state to move to while within non-quoted header values.</div><div class="ttdef"><b>Definition</b> Parser.php:332</div></div>
<div class="ttc" id="agroup___support_html_ga4f0f28af205235b0726da91caf226b9f"><div class="ttname"><a href="../../d5/d41/group___support.html#ga4f0f28af205235b0726da91caf226b9f">fopen</a></div><div class="ttdeci">fopen()</div><div class="ttdoc">Return a stream handle to this stream.</div><div class="ttdef"><b>Definition</b> CombineStream.php:46</div></div>
<div class="ttc" id="agroup__core_html_ga4806e88f79ea3f4220bb2e1bc67ed1a2"><div class="ttname"><a href="../../d0/de1/group__core.html#ga4806e88f79ea3f4220bb2e1bc67ed1a2">defined</a></div><div class="ttdeci">defined( 'HUB_MOODLEORGHUBURL')||define( 'HUB_MOODLEORGHUBURL'</div><div class="ttdoc">URL of the Moodle sites registration portal.</div><div class="ttdef"><b>Definition</b> moodlelib.php:499</div></div>
<div class="ttc" id="agroup__tool__log_html_ga7543e29bf5065f86f5b6ec5145aacc77"><div class="ttname"><a href="../../d7/d02/group__tool__log.html#ga7543e29bf5065f86f5b6ec5145aacc77">tool_log\helper\flush</a></div><div class="ttdeci">flush()</div><div class="ttdoc">Flush event buffer.</div><div class="ttdef"><b>Definition</b> buffered_writer.php:99</div></div>
<div class="ttc" id="anamespacearray_html"><div class="ttname"><a href="../../d7/df9/namespacearray.html">array</a></div><div class="ttdoc">('') &amp;#160;</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 4 2023 03:16:00 for Moodle PHP Documentation by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7
</small></address>
</body>
</html>
